<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoom Chat Viewer</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="./assets/jquery-3.5.1.min.js"></script>
    <script src="./assets/vue-2.6.12.js"></script>
    <link rel="stylesheet" href="./assets/bulma.min.css">
    <style>
        p {
            margin: 1em 0;
        }

        label.file-label {
            width: 100%;
        }

        .file-name {
            max-width: initial;
        }

        .preWrap {
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <section id="vm-app" class="section" v-cloak @drop.prevent="addFile" @dragover.prevent>
        <div class="container">
            <h1 class="title">Zoom Chat Viewer</h1>
            <div class="columns">
                <div class="column">

                    <p>Drag the Zoom chat .txt file to the area below, or click "Open file".</p>

                    <div class="file has-name is-boxed" :class="file_status">
                        <label class="file-label">
                            <input class="file-input" type="file" name="file-input">
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label">{{file_label}}</span>
                            </span>
                            <span class="file-name">{{file_name}}</span>
                        </label>
                    </div>

                    <table class="table" v-if="list.length">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>From</th>
                                <th v-if="chatType == 'private'">To</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="chat in list">
                                <td>{{chat.timestamp}}</td>
                                <td>{{chat.from}}</td>
                                <td v-if="chatType == 'private'">{{chat.to}}</td>
                                <td class="preWrap">{{chat.message}}</td>
                            </tr>
                        </tbody>
                    </table>

                </div>
            </div>
    </section>

    <script>
        const privateChatLineRegex = /^(\d\d:\d\d:\d\d) From  (.*?)  to  (.*?) : ([\s\S]+)/
        const publicChatOldRegex = /^(\d\d:\d\d:\d\d)\t From  (.*?) : ([\s\S]+)/

        function getExtensionFromFilename(fileName) {
            const extensionMatch = fileName.match(/\.(\w+)$/)
            return extensionMatch ? extensionMatch[0] : ''
        }

        function determineChatType(line) {

            // 12:58:22	Erik Newhard:	<message>
            if (line.split('\t').length == 3) // chat.txt // full session, public chat
                return 'public'

            // 12:58:22 From  Erik Newhard  to  Everyone : <message>
            else if (line.match(privateChatLineRegex)) // meeting_saved_chat.txt // personally saved file
                // what if user name contains '  to  ' or ' : '?
                return 'private'

            // 12:58:22	 From  Erik Newhard : <message>
            else if (line.match(publicChatOldRegex)) // meeting_saved_chat.txt // automatically saved file, old
                return 'publicOld'

            else
                return 'unknown'
        }

        function parsePublicChat(line) {
            const l = line.split('\t')
            return {
                timestamp: l[0],
                from: l[1],
                message: l[2]
            }
        }

        function parsePrivateChat(line, i) {
            const l = line.match(privateChatLineRegex)
            return {
                timestamp: l[1],
                from: l[2],
                to: l[3],
                message: l[4]
            }
        }

        function parsePublicOldChat(line, i) {
            const l = line.match(publicChatOldRegex)
            return {
                timestamp: l[1],
                from: l[2],
                message: l[3]
            }
        }

        function fixMultiline(lines, chatType) {
            for (let i = 0; i < lines.length; i++) {
                if ((chatType == 'public' && lines[i].split('\t').length != 3) ||
                    (chatType == 'private' && !lines[i].match(privateChatLineRegex)) ||
                    (chatType == 'publicOld' && !lines[i].match(publicChatOldRegex))
                ) {
                    lines[i - 1] += '\n' + lines[i]
                    lines.splice(i, 1)
                    i--
                }
            }
            return lines
        }

        var vm = new Vue({
            el: "#vm-app",

            data: {
                file_status: '',
                file_label: 'Open file...',
                file_name: '',
                list: [],
                chatType: '',
            },

            computed: {
            },

            mounted() { },

            methods: {

                parseData(txt) {

                    let lines = txt.trim().split('\n')

                    const chatType = determineChatType(lines[0]) // ['public', 'private', 'publicOld', 'unknown']
                    this.chatType = chatType

                    lines = fixMultiline(lines, chatType)

                    if (chatType == 'public')
                        this.list = lines.map(parsePublicChat)

                    else if (chatType == 'private')
                        this.list = lines.map(parsePrivateChat)

                    if (chatType == 'publicOld')
                        this.list = lines.map(parsePublicOldChat)

                    else if (chatType == 'unknown')
                        console.log(`Error: Can't determine chat type from\n`, lines[0])

                },

                addFile(e) {
                    let file = e.dataTransfer.files[0]

                    if (!file) return

                    let _this = this

                    const reader = new FileReader()
                    reader.onload = loadData
                    reader.readAsText(file)

                    function loadData(event) {
                        _this.file_name = file.name

                        const ext = getExtensionFromFilename(file.name)

                        if (ext == '.txt') {
                            const data = event.target.result

                            _this.file_status = "is-success"
                            _this.file_label = `${ext} file loaded!`

                            _this.parseData(data)
                        } else {
                            _this.file_status = "is-danger"
                            _this.file_label = `${ext} is not a supported file extension. Please try again`
                        }
                    }
                },
            },
        })
    </script>

</body>

</html>