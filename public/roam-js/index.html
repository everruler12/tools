<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erik's {{roam/js}} Scripts</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="/assets/jquery-3.5.1.min.js"></script>
    <script src="/assets/vue-2.6.12.js"></script>
    <link rel="stylesheet" href="/assets/bulma.min.css">
    <style>
    </style>
</head>

<body>
    <section id="vm-app-roam-clipboard" class="section">
        <div class="container">
            <h1 class="title">Roam Clipboard</h1>
            <p>Instructions: Copy Roam blocks and paste in the textarea below to create HTML for download.</p>
            <div class="columns">
                <div class="column">
                    <input v-model="name" placeholder="Name" @focus="$event.target.select()">
                    <!-- <textarea id="clipboard-input" class="textarea" v-model="clipboard_input" placeholder="Paste here" @focus="clipboard_input=''"  @paste="clipboard_input=''"></textarea> -->
                    <textarea id="clipboard-input" class="textarea" v-model="clipboard_input" placeholder="Paste here" @focus="clipboard_input=''"></textarea>
                    <!-- <button class="button" @click="clipboard_input=''">Clear</button> -->
                </div>

                <div class="column">
                    <p>Clipboard data:</p>
                    <div>
                        <textarea class="textarea" v-model="output_pretty" readonly></textarea>
                        <!-- <button class="button" @click="clipboard_output={}">Clear</button> -->
                        <button class="button" @click="copy(output_pretty)">Copy above result as plain text</button>
                        <button class="button" @click="copyRoamData(clipboard_output)">Copy back as Roam data</button>
                    </div>
                    <div>
                        <br>
                        <textarea class="textarea" v-model="clipboard_output_html" readonly></textarea>
                        <button class="button" @click="copyHtml(clipboard_output)">Copy</button>
                        <button class="button" @click="downloadHtml(clipboard_output)">Download</button>
                    </div>
                </div>
            </div>


        </div>
    </section>

    <script>
        // TODO: if no roam/data, convert script as plain text into roam data
        var vm = new Vue({
            el: "#vm-app-roam-clipboard",
            data: {
                name: 'Roam blocks',
                clipboard_input: '',
                clipboard_output: {},
                clipboard_output_html: '',
                scripts: [{
                    name: 'add-highlights-escaped-from-bold-keyboard-shortcut',
                    clipboard_data: {
                        "text_plain": "\n{{roam/js}}\n    ```javascript\n/*\nAdd highlights escaped from bold with Ctrl/Cmd + Shift + H\nBy Erik Newhard\nhttps://roamresearch.com/#/app/roam-depot-developers/page/qIMQKcZh7\n*/\n\n;(function() {\n  let s = document.createElement('script')\n  s.src = \"https://tools.eriknewhard.com/roam-js/add-highlights-escaped-from-bold-keyboard-shortcut.js\"\n  document.head.appendChild(s)\n})();```\n\n",
                        "text_html": "<html>\r\n<body>\r\n<!--StartFragment--><div><p style=\"text-align:inherit;\"><span style=\"white-space:pre;\"></span><span style=\"text-align:inherit;\"><span></span></span></p><p style=\"text-align:inherit;\"><span style=\"white-space:pre;\"></span><span style=\"text-align:inherit;\"><span>{{roam/js}}</span></span><div><p style=\"text-align:inherit;\"><span style=\"white-space:pre;\">\t</span><span style=\"text-align:inherit;\"><span><pre><code>javascript\n/*\nAdd highlights escaped from bold with Ctrl/Cmd + Shift + H\nBy Erik Newhard\nhttps://roamresearch.com/#/app/roam-depot-developers/page/qIMQKcZh7\n*/\n\n;(function() {\n  let s = document.createElement('script')\n  s.src = \"https://tools.eriknewhard.com/roam-js/add-highlights-escaped-from-bold-keyboard-shortcut.js\"\n  document.head.appendChild(s)\n})();</code></pre></span></span></p></div></p><p style=\"text-align:inherit;\"><span style=\"white-space:pre;\"></span><span style=\"text-align:inherit;\"><span></span></span></p></div><!--EndFragment-->\r\n</body>\r\n</html>",
                        "roam_data": "[\"^ \",\"~:db-id\",\"roam-depot-developers\",\"~:type\",\"~:copy\",\"~:copied-data\",[[\"^ \",\"~:block/string\",\"\",\"~:children/view-type\",\"~:document\",\"~:create/email\",\"erik.newhard@gmail.com\",\"~:create/time\",1600921187513,\"~:block/uid\",\"BNNgX6o0l\",\"~:block/open\",true,\"~:edit/time\",1600924748968,\"~:edit/email\",\"erik.newhard@gmail.com\",\"~:block/order\",7],[\"^ \",\"^4\",\"{{roam/js}}\",\"^7\",\"erik.newhard@gmail.com\",\"^8\",1600920980996,\"~:block/children\",[[\"^ \",\"^4\",\"~```javascript\\n/*\\nAdd highlights escaped from bold with Ctrl/Cmd + Shift + H\\nBy Erik Newhard\\nhttps://roamresearch.com/#/app/roam-depot-developers/page/qIMQKcZh7\\n*/\\n\\n;(function() {\\n  let s = document.createElement('script')\\n  s.src = \\\"https://tools.eriknewhard.com/roam-js/add-highlights-escaped-from-bold-keyboard-shortcut.js\\\"\\n  document.head.appendChild(s)\\n})();```\",\"^7\",\"erik.newhard@gmail.com\",\"^8\",1600921175646,\"^9\",\"f9f1BFs5H\",\"^:\",true,\"^;\",1600964872243,\"^<\",\"erik.newhard@gmail.com\",\"^=\",0]],\"^9\",\"-zI-sl2wA\",\"^:\",true,\"^;\",1600920988194,\"^<\",\"erik.newhard@gmail.com\",\"^=\",8],[\"^ \",\"^4\",\"\",\"^7\",\"erik.newhard@gmail.com\",\"^8\",1600924350980,\"^9\",\"pu3Br1Ssw\",\"^:\",true,\"^;\",1600924763834,\"^<\",\"erik.newhard@gmail.com\",\"^=\",9]]]"
                    }
                }]
            },

            computed: {
                output_pretty() {
                    return JSON.stringify(this.clipboard_output, null, 2)
                },
                html_name() {
                    return this.name.toLowerCase().split(' ').join('-') + '.html'
                }
            },

            mounted() {
                this.listenForPaste()
            },

            methods: {
                listenForPaste() {
                    let _this = this
                    let el = document.getElementById("clipboard-input")
                    el.addEventListener("paste", function(e) {
                        // console.log(e.clipboardData)
                        let clipboard_data = {
                            name: _this.name,
                            html_name: _this.html_name,
                            text_plain: e.clipboardData.getData("text/plain"),
                            text_html: e.clipboardData.getData("text/html"),
                            roam_data: e.clipboardData.getData("roam/data")
                        }
                        // console.log(clipboard_data)

                        if (clipboard_data.roam_data == "") {
                            alert("That is not valid roam/data")
                            _this.clipboard_input = ''
                        } else {
                            _this.clipboard_output = clipboard_data
                            _this.clipboard_output_html = _this.clipboardDataToHtml(clipboard_data)
                        }
                    })
                },

                copy(text_to_copy) {
                    function listener(e) {
                        e.clipboardData.setData("text/plain", text_to_copy)
                        e.preventDefault()
                    }

                    document.addEventListener("copy", listener)

                    try {
                        document.execCommand("copy")
                        console.log("Copied:", text_to_copy)
                    } catch (e) {
                        console.log("Copy failed.", e)
                    } finally {
                        document.removeEventListener("copy", listener)
                    }
                },

                copyRoamData(clipboard_data) {
                    clipboard_data = JSON.parse(JSON.stringify(clipboard_data))

                    function listener(e) {
                        e.clipboardData.setData("text/plain", clipboard_data.text_plain)
                        e.clipboardData.setData("text/html", clipboard_data.text_html)
                        e.clipboardData.setData("roam/data", clipboard_data.roam_data)
                        e.preventDefault()
                    }

                    document.addEventListener("copy", listener)

                    try {
                        document.execCommand("copy")
                        console.log("Copied:", clipboard_data)
                    } catch (e) {
                        console.log("Copy failed.", e)
                    } finally {
                        document.removeEventListener("copy", listener)
                    }
                },

                clipboardDataToHtml(clipboard_data) {
                    clipboard_data = JSON.parse(JSON.stringify(clipboard_data))

                    let code = `let l = function(e) {
e.clipboardData.setData("text/plain", ${JSON.stringify(clipboard_data.text_plain)})
e.clipboardData.setData("text/html", ${JSON.stringify(clipboard_data.text_html)})
e.clipboardData.setData("roam/data", ${JSON.stringify(clipboard_data.roam_data)})
e.preventDefault()
}
document.addEventListener("copy", l)
document.execCommand("copy")
document.removeEventListener("copy", l)`

                    let bookmarklet = 'javascript:' + encodeURIComponent(`;(()=>{${code}})();`)

                    return /*html*/ `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${clipboard_data.name}</title>
    <style>
        body {overflow: hidden;}
        form {margin-block-end: 0;}
        button {height: 2.5em; cursor: pointer;}
    </style>
</head>
<body>
    <form action="${bookmarklet}">
        <button title="${clipboard_data.name}">Copy code</button>
    </form>
</body>
</html>`
                },

                downloadHtml(clipboard_data) {
                    let html = this.clipboardDataToHtml(clipboard_data)

                    let a = $('<a>', {
                        'href': 'data:text/html;charset=utf-8,' + encodeURIComponent(html),
                        'download': clipboard_data.html_name,
                        'style': 'display:none;'
                    }).appendTo('body')
                    a[0].click()
                    a.remove()
                },

                copyHtml(clipboard_data) {
                    let html = this.clipboardDataToHtml(clipboard_data)

                    this.copy(html)
                }
            },
        })
    </script>

</body>

</html>